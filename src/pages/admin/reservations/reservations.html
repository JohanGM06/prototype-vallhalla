<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VALHALLA - Sistema de Administración de Propiedades</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css" />
  <!-- SweetAlert2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">

  <!-- JavaScript Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

  <style>
    #sidebar {
      transition: margin 0.3s ease-in-out;
    }

    #sidebar.collapsed {
      margin-left: -280px;
    }

    .bg-success {
      cursor: pointer;
    }

    .bg-danger {
      cursor: pointer;
    }

    /* Add styles for Flatpickr */
    .occupied-date {
      background-color: #ffebee !important;
      color: #d32f2f !important;
      text-decoration: line-through;
    }

    .flatpickr-day.occupied-date:hover {
      background-color: #ffcdd2 !important;
    }

    .calendar-wrapper {
      min-height: 300px;
    }

    .flatpickr-calendar.inline {
      width: 100%;
      max-width: none;
      box-shadow: none;
    }

    .flatpickr-rContainer {
      width: 100%;
    }

    .flatpickr-days {
      width: 100% !important;
    }

    .dayContainer {
      width: 100%;
      min-width: 100%;
      max-width: 100%;
      display: flex;
      flex-wrap: wrap;
    }

    .flatpickr-day {
      width: calc(100% / 7);
      max-width: none;
      flex-basis: calc(100% / 7);
      height: 50px;
      line-height: 50px;
      margin: 0;
      border-radius: 0;
    }

    .flatpickr-day.available {
      background-color: #198754;
      color: white;
    }

    .flatpickr-day.occupied {
      background-color: #dc3545;
      color: white;
    }

    .flatpickr-day.today {
      border: 2px solid #0d6efd;
    }

    @media (max-width: 768px) {
      .flatpickr-day {
        height: 40px;
        line-height: 40px;
      }
    }
  </style>
</head>

<body>
  <div class="container-fluid">
    <div class="row flex-nowrap">
      <!-- Sidebar -->
      <div class="row flex-nowrap">
        <!-- Sidebar -->
        <div id="sidebar" class="col-auto px-0 bg-white border-end" style="width: 280px;">
          <div class="d-flex flex-column align-items-center align-items-sm-start px-3 pt-2 min-vh-100">
            <a href="/"
              class="d-flex align-items-center pb-3 mb-md-1 mt-md-3 me-md-auto text-dark text-decoration-none">
              <span class="fs-5 fw-bolder">VALHALLA</span>
            </a>
            <ul class="nav flex-column mb-sm-auto mb-0 align-items-center align-items-sm-start w-100">
              <li class="nav-item w-100">
                <a href="#" class="nav-link text-dark px-0">
                  <i class="bi bi-house"></i> <span class="ms-2">INICIO</span>
                </a>
              </li>
              <li class="nav-item w-100">
                <a href="#" class="nav-link text-dark px-0">
                  <i class="bi bi-people"></i> <span class="ms-2">PROPIETARIOS</span>
                </a>
              </li>
              <li class="nav-item w-100">
                <a href="#" class="nav-link text-dark px-0">
                  <i class="bi bi-person-check"></i> <span class="ms-2">ARRENDATARIOS</span>
                </a>
              </li>
              <li class="nav-item w-100">
                <a href="#" class="nav-link text-dark px-0">
                  <i class="bi bi-shield"></i> <span class="ms-2">VIGILANTE</span>
                </a>
              </li>
              <li class="nav-item w-100">
                <a href="#" class="nav-link text-dark px-0">
                  <i class="bi bi-building"></i> <span class="ms-2">TORRES</span>
                </a>
              </li>
              <li class="nav-item w-100">
                <a href="#" class="nav-link text-dark px-0">
                  <i class="bi bi-house-door"></i> <span class="ms-2">APARTAMENTOS</span>
                </a>
              </li>
              <li class="nav-item w-100">
                <a href="#" class="nav-link text-dark px-0">
                  <i class="bi bi-credit-card"></i> <span class="ms-2">PAGOS</span>
                </a>
              </li>
              <li class="nav-item w-100">
                <a href="#" class="nav-link text-dark px-0">
                  <i class="bi bi-clipboard-data"></i> <span class="ms-2">ENCUESTAS</span>
                </a>
              </li>
              <li class="nav-item w-100">
                <a href="#" class="nav-link text-dark px-0">
                  <i class="bi bi-calendar-check"></i> <span class="ms-2">RESERVAS</span>
                </a>
              </li>
              <li class="nav-item w-100">
                <a href="#" class="nav-link text-dark px-0">
                  <i class="bi bi-question-circle"></i> <span class="ms-2">PQRS</span>
                </a>
              </li>
              <li class="nav-item w-100">
                <a href="#" class="nav-link text-dark px-0">
                  <i class="bi bi-bell"></i> <span class="ms-2">NOTIFICACIONES</span>
                </a>
              </li>
              <li class="nav-item w-100">
                <a href="#" class="nav-link text-dark px-0">
                  <i class="bi bi-p-square"></i> <span class="ms-2">PARQUEADERO</span>
                </a>
              </li>
              <li class="nav-item w-100">
                <a href="#" class="nav-link text-dark px-0">
                  <i class="bi bi-heart"></i> <span class="ms-2">MASCOTA</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
        <!-- Main Content -->
        <div class="col p-0">
          <!-- Topbar -->
          <nav class="navbar navbar-expand-lg bg-white border-bottom px-3">
            <div class="container-fluid">
              <div class="d-flex align-items-center">
                <button class="btn btn-link text-dark px-0 me-3" id="sidebarToggle">
                  <i class="bi bi-list fs-4"></i>
                </button>
                <span class="navbar-text fs-5">BIENVENIDO ADMINISTRADOR</span>
              </div>

              <div class="d-flex align-items-center ms-auto">
                <div class="input-group me-3">
                  <span class="input-group-text bg-white border-end-0">
                    <i class="bi bi-search"></i>
                  </span>
                  <input type="text" class="form-control border-start-0" placeholder="Search">
                </div>

                <button class="btn btn-link text-dark">
                  <i class="bi bi-bell fs-5"></i>
                </button>
                <button class="btn btn-link text-dark">
                  <i class="bi bi-envelope fs-5"></i>
                </button>
                <button class="btn btn-link text-dark">
                  <i class="bi bi-escape fs-5"></i>
                </button>
              </div>
            </div>
          </nav>

          <!-- Main content area -->
          <div class="container-fluid p-4">
            <h2 class="mb-4">Reservas de Áreas Comunes</h2>

            <div class="row">
              <!-- Calendar Section -->
              <div class="col-md-8">
                <div class="card">
                  <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                     
                      <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                          data-bs-toggle="dropdown">
                          <i class="bi bi-filter"></i> Estado
                        </button>
                        <ul class="dropdown-menu">
                          <li><a class="dropdown-item" href="#">Disponible</a></li>
                          <li><a class="dropdown-item" href="#">Ocupado</a></li>
                        </ul>
                      </div>
                    </div>
                  </div>
                  <div class="card-body p-0">
                    <div id="mainCalendar" class="w-100"></div>
                  </div>
                </div>
              </div>

              <!-- Reservations List Section -->
              <div class="col-md-4">
                <div class="card">
                  <div class="card-header bg-white">
                    <h5 class="mb-0">Reservas Actuales</h5>
                  </div>
                  <div class="card-body">
                    <!-- Current Reservations -->
                    <div class="list-group">
                      <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                          <div>
                            <h6 class="mb-1">APT #101</h6>
                            <small class="text-muted">22-11-2024 - 23-11-2024</small>
                          </div>
                          <div>
                            <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal"
                              data-bs-target="#editReservationModal">
                              <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary me-1" data-bs-toggle="modal"
                              data-bs-target="#viewReservationModal">
                              <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete(this)">
                              <i class="bi bi-trash"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                      <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                          <div>
                            <h6 class="mb-1">APT #101</h6>
                            <small class="text-muted">22-11-2024 - 23-11-2024</small>
                          </div>
                          <div>
                            <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal"
                              data-bs-target="#editReservationModal">
                              <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary me-1" data-bs-toggle="modal"
                              data-bs-target="#viewReservationModal">
                              <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete(this)">
                              <i class="bi bi-trash"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                      <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                          <div>
                            <h6 class="mb-1">APT #101</h6>
                            <small class="text-muted">22-11-2024 - 23-11-2024</small>
                          </div>
                          <div>
                            <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal"
                              data-bs-target="#editReservationModal">
                              <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary me-1" data-bs-toggle="modal"
                              data-bs-target="#viewReservationModal">
                              <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete(this)">
                              <i class="bi bi-trash"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                      <!-- Add more reservations as needed -->
                    </div>

                    <!-- Add Reservation Button -->
                    <button class="btn btn-primary w-100 mt-3" data-bs-toggle="modal"
                      data-bs-target="#createReservationModal">
                      <i class="bi bi-plus-circle me-2"></i>Nueva Reserva
                    </button>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Reservation Modal -->
    <div class="modal fade" id="createReservationModal" tabindex="-1" aria-labelledby="createReservationModalLabel"
      aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="createReservationModalLabel">Crear Reservación</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="createReservationForm" class="needs-validation" novalidate>
              <div class="mb-3">
                <label for="createTipoZona" class="form-label">Tipo de Zona</label>
                <select class="form-select" id="createTipoZona" required>
                  <option value="">Seleccione una zona</option>
                  <option value="SALON COMUNAL">SALON COMUNAL</option>
                  <option value="PARRILLA">PARRILLA</option>
                  <option value="PISCINA">PISCINA</option>
                </select>
                <div class="invalid-feedback">
                  Por favor seleccione una zona
                </div>
              </div>
              <div class="mb-3">
                <label for="createFecha" class="form-label">Fecha</label>
                <div class="calendar-wrapper border rounded p-3">
                  <input type="text" id="createFecha" class="d-none" required>
                </div>
                <div class="invalid-feedback">
                  Por favor seleccione una fecha
                </div>
              </div>
              <div class="mb-3">
                <label for="createHora" class="form-label">Hora</label>
                <select class="form-select" id="createHora" required>
                  <option value="">Seleccione una hora</option>
                  <option value="08:00">8:00 AM</option>
                  <option value="10:00">10:00 AM</option>
                  <option value="12:00">12:00 PM</option>
                  <option value="14:00">2:00 PM</option>
                  <option value="16:00">4:00 PM</option>
                  <option value="18:00">6:00 PM</option>
                </select>
                <div class="invalid-feedback">
                  Por favor seleccione una hora
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button type="button" class="btn btn-primary" onclick="validateAndSubmit()">Guardar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- View Reservation Modal -->
    <div class="modal fade" id="viewReservationModal" tabindex="-1" aria-labelledby="viewReservationModalLabel"
      aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="viewReservationModalLabel">Ver Reservación</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <label for="viewTipoZona" class="form-label">Tipo de Zona</label>
                <input type="text" class="form-control" id="viewTipoZona" value="" readonly>
              </div>
              <div class="mb-3">
                <label for="viewFechaInicial" class="form-label">Fecha Inicial</label>
                <input type="text" class="form-control" id="viewFechaInicial" readonly>
              </div>
              <div class="mb-3">
                <label for="viewFechaFinal" class="form-label">Fecha Final</label>
                <input type="text" class="form-control" id="viewFechaFinal" readonly>
              </div>
              <div class="mb-3">
                <label for="viewHora" class="form-label">Hora</label>
                <input type="text" class="form-control" id="viewHora" readonly>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Reservation Modal -->
    <div class="modal fade" id="editReservationModal" tabindex="-1" aria-labelledby="editReservationModalLabel"
      aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editReservationModalLabel">Editar Reservación</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="editReservationForm" class="needs-validation" novalidate>
              <div class="mb-3">
                <label for="editTipoZona" class="form-label">Tipo de Zona</label>
                <select class="form-select" id="editTipoZona" required>
                  <option value="">Seleccione una zona</option>
                  <option value="SALON COMUNAL">SALON COMUNAL</option>
                  <option value="PARRILLA">PARRILLA</option>
                  <option value="PISCINA">PISCINA</option>
                </select>
                <div class="invalid-feedback">
                  Por favor seleccione una zona
                </div>
              </div>
              <div class="mb-3">
                <label for="editFecha" class="form-label">Fecha</label>
                <div class="calendar-wrapper border rounded p-3">
                  <input type="text" id="editFecha" class="d-none" required>
                </div>
                <div class="invalid-feedback">
                  Por favor seleccione una fecha
                </div>
              </div>
              <div class="mb-3">
                <label for="editHora" class="form-label">Hora</label>
                <select class="form-select" id="editHora" required>
                  <option value="">Seleccione una hora</option>
                  <option value="08:00">8:00 AM</option>
                  <option value="10:00">10:00 AM</option>
                  <option value="12:00">12:00 PM</option>
                  <option value="14:00">2:00 PM</option>
                  <option value="16:00">4:00 PM</option>
                  <option value="18:00">6:00 PM</option>
                </select>
                <div class="invalid-feedback">
                  Por favor seleccione una hora
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button type="button" class="btn btn-primary" onclick="validateAndSubmitEdit()">Guardar Cambios</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS (includes Popper.js) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Toggle Script -->
    <script>
      document.getElementById('sidebarToggle').addEventListener('click', function () {
        document.getElementById('sidebar').classList.toggle('collapsed');
      });

      window.addEventListener('resize', () => {
        if (window.innerWidth < 992) { // Less than lg
          const sidebar = document.getElementById('sidebar');
          if (!sidebar.classList.contains('collapsed')) {
            sidebar.classList.add('collapsed');
          }
        } else {
          const sidebar = document.getElementById('sidebar');
          if (sidebar.classList.contains('collapsed')) {
            sidebar.classList.remove('collapsed');
          }
        }
      });

      // Initialize Flatpickr with Spanish locale
      flatpickr.localize(flatpickr.l10ns.es);

      // Mock occupied dates with specific hours
      const occupiedDates = [
        { date: '2024-03-20', hours: ['10:00', '14:00'] },
        { date: '2024-03-22', hours: ['08:00', '16:00'] },
        { date: '2024-03-25', hours: ['12:00'] },
        { date: '2024-03-28', hours: ['14:00', '16:00'] },
        { date: '2024-04-01', hours: ['08:00', '10:00', '12:00'] },
        { date: '2024-04-05', hours: ['16:00', '18:00'] }
      ];

      let createCalendar, editCalendar;

      // Function to initialize a calendar
      function initializeCalendar(inputId, existingCalendar) {
        if (existingCalendar) {
          existingCalendar.destroy();
        }

        return flatpickr(`#${inputId}`, {
          locale: 'es',
          inline: true,
          monthSelectorType: 'static',
          dateFormat: 'Y-m-d',
          minDate: 'today',
          maxDate: new Date().fp_incr(90),
          disable: occupiedDates.map(d => d.date),
          onChange: function (selectedDates, dateStr) {
            if (selectedDates[0]) {
              updateAvailableHours(selectedDates[0], inputId.includes('create') ? 'create' : 'edit');
            }
          },
          onDayCreate: function (dObj, dStr, fp, dayElem) {
            const dateStr = dayElem.dateObj.toISOString().split('T')[0];
            const isOccupied = occupiedDates.some(d => d.date === dateStr);

            if (isOccupied) {
              dayElem.title = "Ocupado";
              dayElem.classList.add('occupied-date');
            }
          }
        });
      }

      // Function to update available hours
      function updateAvailableHours(selectedDate, mode) {
        const horaSelect = document.getElementById(`${mode}Hora`);
        const dateStr = selectedDate.toISOString().split('T')[0];
        const occupiedDate = occupiedDates.find(d => d.date === dateStr);

        // Reset hour selection
        horaSelect.value = '';

        // Enable all options first
        Array.from(horaSelect.options).forEach(option => {
          option.disabled = false;
        });

        if (occupiedDate) {
          // Disable occupied hours
          occupiedDate.hours.forEach(hour => {
            const option = Array.from(horaSelect.options).find(opt => opt.value === hour);
            if (option) {
              option.disabled = true;
            }
          });
        }
      }

      // Initialize calendars when modals are shown
      document.addEventListener('DOMContentLoaded', function () {
        // Initialize create modal calendar
        document.getElementById('createReservationModal').addEventListener('shown.bs.modal', function () {
          createCalendar = initializeCalendar('createFecha', createCalendar);
        });

        // Initialize edit modal calendar
        document.getElementById('editReservationModal').addEventListener('shown.bs.modal', function () {
          editCalendar = initializeCalendar('editFecha', editCalendar);
        });

        // Clean up when modals are hidden
        document.getElementById('createReservationModal').addEventListener('hidden.bs.modal', function () {
          if (createCalendar) {
            createCalendar.destroy();
            createCalendar = null;
          }
        });

        document.getElementById('editReservationModal').addEventListener('hidden.bs.modal', function () {
          if (editCalendar) {
            editCalendar.destroy();
            editCalendar = null;
          }
        });
      });

      // Set min date to today for date inputs
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('createFecha').min = today;
      document.getElementById('editFecha').min = today;

      // Update final date min when initial date changes
      document.getElementById('createFecha').addEventListener('change', function () {
        document.getElementById('createFecha').value = this.value;
      });

      document.getElementById('editFecha').addEventListener('change', function () {
        document.getElementById('editFecha').value = this.value;
      });

      function validateAndSubmit() {
        console.log("validateAndSubmit function called"); // Debugging line

        const form = document.getElementById('createReservationForm');
        if (!form) {
          console.error("Form not found"); // Debugging line
          return;
        }

        // Validate form
        if (!form.checkValidity()) {
          console.log("Form is not valid"); // Debugging line
          form.classList.add('was-validated');
          return;
        }
        console.log("Form is valid"); // Debugging line

        // Get form values
        const tipoZona = document.getElementById('createTipoZona').value;
        const fecha = document.getElementById('createFecha').value;
        const hora = document.getElementById('createHora').value;

        // Debugging: Log form values
        console.log("Tipo de Zona:", tipoZona);
        console.log("Fecha:", fecha);
        console.log("Hora:", hora);

        // Additional validation
        if (new Date(fecha) < new Date(today)) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'La fecha no puede ser anterior a la fecha actual'
          });
          return;
        }

        // Show confirmation dialog
        Swal.fire({
          title: '¿Está seguro?',
          text: "¿Desea crear esta reservación?",
          icon: 'question',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Sí, crear',
          cancelButtonText: 'Cancelar'
        }).then((result) => {
          if (result.isConfirmed) {
            console.log("User confirmed reservation creation"); // Debugging line
            const modal = bootstrap.Modal.getInstance(document.getElementById('createReservationModal'));
            if (modal) {
              modal.hide();
            }
            form.reset();
            form.classList.remove('was-validated');
            // Add new reservation to the list
            const listGroup = document.querySelector('.list-group');
            if (!listGroup) {
              console.error("List group not found"); // Debugging line
              return;
            }
            Swal.fire({
              icon: 'success',
              title: '¡Reserva creada correctamente!',
              text: 'La reservación ha sido creada exitosamente',
              timer: 2000,
              showConfirmButton: false
            })
            const newReservation = document.createElement('div');
            newReservation.className = 'list-group-item';
            newReservation.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-1">APT #101</h6>
            <small class="text-muted">${fecha} - ${hora}</small>
          </div>
          <div>
            <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal"
              data-bs-target="#editReservationModal">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-secondary me-1" data-bs-toggle="modal"
              data-bs-target="#viewReservationModal">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete(this)">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      `;

            // Add the new reservation at the top of the list
            listGroup.prepend(newReservation);

            // Add the date to occupied dates (for calendar)
            const existingDate = occupiedDates.find(d => d.date === fecha);
            if (existingDate) {
              // Add the hour if it doesn't exist
              if (!existingDate.hours.includes(hora)) {
                existingDate.hours.push(hora);
              }
            } else {
              // Add new date with this hour
              occupiedDates.push({ date: fecha, hours: [hora] });
            }


            // Show success message

          }
        });
      }
      // Reset form when modal is closed
      document.getElementById('createReservationModal').addEventListener('hidden.bs.modal', function () {
        const form = document.getElementById('createReservationForm');
        form.reset();
        form.classList.remove('was-validated');
      });

      // Update editReservation function
      function editReservation(id) {
        const reservation = mockReservations.find(r => r.id === id);
        if (reservation) {
          document.getElementById('editTipoZona').value = reservation.tipoZona;
          if (editCalendar) {
            editCalendar.setDate(reservation.fechaInicial);
          }
          document.getElementById('editHora').value = reservation.hora;

          document.getElementById('editReservationForm').setAttribute('data-reservation-id', id);
        }
      }

      // Update validateAndSubmitEdit function
      function validateAndSubmitEdit() {
        const form = document.getElementById('editReservationForm');
        const id = parseInt(form.getAttribute('data-reservation-id'));

        if (!form.checkValidity()) {
          form.classList.add('was-validated');
          return;
        }

        const tipoZona = document.getElementById('editTipoZona').value;
        const fecha = editCalendar.selectedDates[0];
        const hora = document.getElementById('editHora').value;

        if (!fecha) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Por favor seleccione una fecha'
          });
          return;
        }

        Swal.fire({
          title: '¿Está seguro?',
          text: "¿Desea guardar los cambios en esta reservación?",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Sí, guardar',
          cancelButtonText: 'Cancelar'
        }).then((result) => {
          if (result.isConfirmed) {
            // Update mock data
            const index = mockReservations.findIndex(r => r.id === id);
            if (index > -1) {
              mockReservations[index] = {
                ...mockReservations[index],
                tipoZona,
                fechaInicial: fecha.toISOString().split('T')[0],
                fechaFinal: fecha.toISOString().split('T')[0],
                hora
              };

              renderReservations();

              Swal.fire({
                icon: 'success',
                title: '¡Cambios guardados!',
                text: 'La reservación ha sido actualizada exitosamente',
                timer: 2000,
                showConfirmButton: false
              }).then(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('editReservationModal'));
                modal.hide();
                form.classList.remove('was-validated');
              });
            }
          }
        });
      }

      document.addEventListener('DOMContentLoaded', function () {
        // Initialize main calendar
        const mainCalendar = flatpickr("#mainCalendar", {
          locale: 'es',
          inline: true,
          monthSelectorType: 'static',
          dateFormat: 'Y-m-d',
          defaultDate: 'today',
          minDate: 'today',
          maxDate: new Date().fp_incr(90),
          onDayCreate: function (dObj, dStr, fp, dayElem) {
            const dateStr = dayElem.dateObj.toISOString().split('T')[0];
            const isOccupied = occupiedDates.some(d => d.date === dateStr);

            if (dayElem.dateObj >= new Date() && dayElem.dateObj <= new Date().fp_incr(90)) {
              if (isOccupied) {
                dayElem.classList.add('occupied');
                dayElem.title = "Ocupado";
              } else {
                dayElem.classList.add('available');
                dayElem.title = "Disponible";
              }
            }
          },
          onChange: function (selectedDates, dateStr) {
            if (selectedDates[0]) {
              const isOccupied = occupiedDates.some(d => d.date === dateStr);
              if (isOccupied) {
                const modal = new bootstrap.Modal(document.getElementById('viewReservationModal'));
                modal.show();
              } else {
                const modal = new bootstrap.Modal(document.getElementById('createReservationModal'));
                modal.show();
              }
            }
          }
        });

        // Update the header buttons to control the main calendar
        document.querySelector('.btn-outline-secondary i.bi-chevron-left').parentElement.addEventListener('click', () => {
          mainCalendar.changeMonth(mainCalendar.currentMonth - 1);
        });

        document.querySelector('.btn-outline-secondary i.bi-chevron-right').parentElement.addEventListener('click', () => {
          mainCalendar.changeMonth(mainCalendar.currentMonth + 1);
        });

        // Update month title
        function updateMonthTitle() {
          const monthYear = mainCalendar.currentYear;
          const monthName = mainCalendar.l10n.months.longhand[mainCalendar.currentMonth];
          document.querySelector('.card-header h5').textContent = `${monthName} ${monthYear}`;
        }

        mainCalendar.config.onMonthChange = function () {
          updateMonthTitle();
        };

        // Initial title update
        updateMonthTitle();
      });

      // Function to show delete confirmation
      function confirmDelete(button) {
        Swal.fire({
          title: '¿Está seguro?',
          text: "Esta reservación será eliminada permanentemente",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#dc3545',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'Sí, eliminar',
          cancelButtonText: 'Cancelar'
        }).then((result) => {
          if (result.isConfirmed) {
            // Get the list item and remove it
            const listItem = button.closest('.list-group-item');

            // Get date info from the item before removing
            const dateText = listItem.querySelector('small.text-muted').textContent;
            const dateParts = dateText.split(' - ');
            const fecha = dateParts[0];
            const hora = dateParts[1];

            // Remove from DOM
            listItem.remove();

            // Remove from occupiedDates array
            const dateIndex = occupiedDates.findIndex(d => d.date === fecha);
            if (dateIndex !== -1) {
              // If this is the only hour for this date, remove the entire date
              if (occupiedDates[dateIndex].hours.length === 1 && occupiedDates[dateIndex].hours[0] === hora) {
                occupiedDates.splice(dateIndex, 1);
              }
              // Otherwise just remove this hour
              else {
                const hourIndex = occupiedDates[dateIndex].hours.indexOf(hora);
                if (hourIndex !== -1) {
                  occupiedDates[dateIndex].hours.splice(hourIndex, 1);
                }
              }
            }

            // Update the calendar if it exists
            if (typeof mainCalendar !== 'undefined') {
              mainCalendar.redraw();
            }

            // Close any open modals
            const openModals = document.querySelectorAll('.modal.show');
            openModals.forEach(modalEl => {
              const modal = bootstrap.Modal.getInstance(modalEl);
              if (modal) {
                modal.hide();
              }
            });

            // Show success message
            Swal.fire({
              icon: 'success',
              title: 'Eliminado',
              text: 'La reservación ha sido eliminada correctamente',
              timer: 1500,
              showConfirmButton: false
            });
          }
        });
      }
    </script>
</body>

</html>